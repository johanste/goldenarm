{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "Name of Virtual Machine"
      }
    },
    "size": {
      "type": "string",
      "defaultValue": "Standard_DS1_V2",
      "metadata": {
        "description": "Size of Virtual Machine"
      }
    },
    "osType": {
      "type": "string",
      "allowedValues": [
        "linux",
        "windows"
      ],
      "defaultValue": "linux"
    },
    "sshPublicKey": {
      "type": "string",
      "defaultValue": ""
    },
    "availabilitySet": {
      "type": "string",
      "defaultValue": ""
    },
    "storageAccount": {
      "type": "string",
      "defaultValue": ""
    },
    "shouldCreateStorageAccount": {
      "type": "bool",
      "defaultValue": true
    },
    "imageReference": {
      "type": "object",
      "defaultValue": { },
      "metadata": {
        "description": "Image reference including id, publisher, offer, sku, version"
      }
    },
    "licenseType": {
      "type": "string",
      "allowedValues": [
        "Windows_Client",
        "Windows_Server",
        ""
      ],
      "defaultValue": ""
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "User name for the Virtual Machine."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Password for the Virtual Machine."
      }
    }
  },
  "variables": {


    "SECTION_VM_START": "",

    "availabilitySetFragmentMap": {
      "true": {
        "availabilitySet": {
          "id": "[parameters('availabilitySet')]"
        }
      },
      "false": { }
    },
    "availabilitySetFragmentMapKey": "[string(greater(length(parameters('availabilitySet')), 0))]",
    "availabilitySetFragment": "[variables('availabilitySetFragmentMap')[variables('availabilitySetFragmentMapKey')]]",


    "licenseTypeFragmentMap": {
      "true": {
        "licenseType": "[parameters('licenseType')]"
      },
      "false": { }
    },
    "licenseTypeFragmentMapKey": "[string(greater(length(parameters('licenseType')), 0))]",
    "licenseTypeFragment": "[variables('licenseTypeFragmentMap')[variables('licenseTypeFragmentMapKey')]]",

    "imageReferenceFragmentToDo": {
      "storageProfile": {
        "imageReference": {
          "publisher": "Canonical",
          "offer": "UbuntuServer",
          "sku": "16.04.0-LTS",
          "version": "latest"
        },
        "osDisk": {
          "createOption": "FromImage"
        },
        "dataDisks": [
          {
            "diskSizeGB": "1023",
            "lun": 0,
            "createOption": "Empty"
          }
        ]
      }
    },

    "storageAccountNameSelector": {
      "true": "[uniqueString(concat(string(subscription()), resourceGroup().name, parameters('name')))]",
      "false": "[parameters('storageAccount')]"
    },
    "effectiveStorageAccountName": "[variables('storageAccountNameSelector')[string(equals(length(parameters('storageAccount')), 0))]]",
    "effectiveStorageAccountSizeToDo": "Standard_LRS",

    "osProfileAdminPasswordFragmentMap": {
      "true": {
        "adminPassword": "[parameters('adminPassword')]"
      },
      "false": { }
    },
    "osProfileAdminPasswordFragment": "[variables('osProfileAdminPasswordFragmentMap')[string(greater(length(parameters('adminPassword')), 0))]]",

    "osProfileBaseProperties": {
      "computerName": "[parameters('name')]",
      "adminUsername": "[parameters('adminUsername')]"
    },

    "osProfilePlatformConfigurations": {
      "linux": {
        "linuxConfiguration": {
          "disablePasswordAuthentication": "[empty(parameters('adminPassword'))]",
          "ssh": {
            "publicKeys": [
              {
                "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
                "keyData": "[parameters('sshPublicKey')]"
              }
            ]
          }
        }
      },
      "windows": {
      }
    },

    "osProfilePlatformConfigurationFragment": "[variables('osProfilePlatformConfigurations')[parameters('osType')]]",

    "osProfileProperties": "[union(variables('osProfileBaseProperties'), variables('osProfileAdminPasswordFragment'), variables('osProfilePlatformConfigurationFragment'))]",

    "vmBaseProperties": {
      "hardwareProfile": {
        "vmSize": "[parameters('size')]"
      },
      "osProfile": "[variables('osProfileProperties')]",
      "networkProfile": {
        "networkInterfaces": [
          {
            "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
          }
        ]
      }
    },

    "vmProperties": "[union(variables('vmBaseProperties'), variables('availabilitySetFragment'), variables('imageReferenceFragmentToDo'))]",

    "nicName": "stenis",
    "addressPrefix": "10.0.0.0/16",
    "subnetName": "Subnet",
    "subnetPrefix": "10.0.0.0/24",
    "storageAccountType": "Standard_LRS",
    "virtualNetworkName": "stenis",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
    "subnetRef": "[concat(variables('vnetID'),'/subnets/',variables('subnetName'))]"
  },
  "resources": [
    {
      "condition": "[parameters('shouldCreateStorageAccount')]",
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('effectiveStorageAccountName')]",
      "apiVersion": "2017-06-01",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "[variables('effectiveStorageAccountSizeToDo')]"
      },
      "kind": "Storage",
      "properties": { }
    },
    {
      "apiVersion": "2017-03-30",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[parameters('name')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/', variables('effectiveStorageAccountName'))]"
      ],
      "properties": "[variables('vmProperties')]"
    }
  ],
  "outputs": {
    "virtualMachine": {
      "type": "object",
      "value": "[reference(parameters('name'))]"
    }
  }
}
